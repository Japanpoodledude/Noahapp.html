<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Schedule Optimizer</title>
    <style>
        /* (all previous styles unchanged) */
        /* ... (keep all your styles from before) ... */
        .delete-btn {
            background: none;
            border: none;
            color: #dc2626;
            font-size: 18px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .delete-btn:hover {
            background: #fee2e2;
        }
        .editable {
            cursor: pointer;
            border-bottom: 1px dotted #2563eb;
        }
        .edit-input {
            width: 90%;
            font-size: inherit;
            font-family: inherit;
            padding: 2px 4px;
            border: 1px solid #a3a3a3;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- (header, sidebar, and other HTML unchanged) -->
        <div class="header">
            <div class="header-top">
                <h1 class="title">üìÖ Production Schedule Optimizer</h1>
                <div>
                    <button class="btn btn-success" onclick="toggleOptimizer()">‚öôÔ∏è Auto Optimize</button>
                </div>
            </div>
            <div class="stats">
                <div>üïê Current Day: <span id="current-day">5</span></div>
                <div>‚ö†Ô∏è Delayed Tasks: <span id="delayed-count">0</span></div>
                <div>üìâ Low Efficiency: <span id="low-efficiency-count">0</span></div>
            </div>
        </div>
        <div id="optimizer-panel" class="optimizer-panel hidden">
            <h3 class="optimizer-title">Schedule Optimization</h3>
            <p class="optimizer-description">
                This will automatically reorganize tasks based on crew efficiency, priorities, and dependencies.
            </p>
            <button class="btn btn-success" onclick="optimizeSchedule()">Optimize Now</button>
            <button class="btn btn-secondary" onclick="toggleOptimizer()">Cancel</button>
        </div>
        <div class="main-content">
            <div class="schedule-section">
                <div class="schedule-header">
                    <h2 class="schedule-title">Production Timeline</h2>
                    <p class="schedule-subtitle">Drag tasks to reschedule them</p>
                </div>
                <div class="timeline">
                    <div class="timeline-grid" id="timeline-grid"></div>
                </div>
            </div>
            <div class="sidebar">
                <div class="panel">
                    <h3 class="panel-title">üë• Crew Performance</h3>
                    <div id="crew-performance"></div>
                </div>
                <div class="panel">
                    <h3 class="panel-title">üìã Task Overview</h3>
                    <div id="task-overview"></div>
                </div>
                <div class="panel">
                    <h3 class="panel-title">‚ö° Quick Actions</h3>
                    <div class="quick-actions">
                        <button class="action-btn blue" onclick="addNewTask()">‚ûï Add Task</button>
                        <button class="action-btn green" onclick="saveSchedule()">üíæ Save Schedule</button>
                        <button class="action-btn gray" onclick="exportSchedule()">üì• Export PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let tasks = [
            { id: 'task-1', name: 'Framing', crew: 'Crew A', duration: 3, startDay: 1, priority: 'high', status: 'in-progress', efficiency: 85 },
            { id: 'task-2', name: 'Electrical', crew: 'Crew B', duration: 2, startDay: 3, priority: 'medium', status: 'scheduled', efficiency: 70 },
            { id: 'task-3', name: 'Plumbing', crew: 'Crew C', duration: 2, startDay: 3, priority: 'medium', status: 'scheduled', efficiency: 90 },
            { id: 'task-4', name: 'Drywall', crew: 'Crew A', duration: 4, startDay: 6, priority: 'high', status: 'scheduled', efficiency: 60 },
            { id: 'task-5', name: 'Flooring', crew: 'Crew D', duration: 3, startDay: 10, priority: 'medium', status: 'scheduled', efficiency: 80 },
            { id: 'task-6', name: 'Painting', crew: 'Crew B', duration: 2, startDay: 11, priority: 'low', status: 'scheduled', efficiency: 75 }
        ];
        const crews = [
            { id: 'crew-a', name: 'Crew A', efficiency: 75, color: '#ff6b6b' },
            { id: 'crew-b', name: 'Crew B', efficiency: 70, color: '#4ecdc4' },
            { id: 'crew-c', name: 'Crew C', efficiency: 90, color: '#45b7d1' },
            { id: 'crew-d', name: 'Crew D', efficiency: 80, color: '#96ceb4' }
        ];
        let currentDay = 5;
        let draggedTask = null;
        let draggedElement = null;
        const projectStartDate = new Date(2025, 5, 23);
        const dayNames = ['Sun.', 'Mon.', 'Tue.', 'Wed.', 'Thu.', 'Fri.', 'Sat.'];
        function generateTimeline() {
            const grid = document.getElementById('timeline-grid');
            grid.innerHTML = '';
            const header = document.createElement('div');
            header.className = 'timeline-header';
            const taskHeader = document.createElement('div');
            taskHeader.className = 'header-cell';
            taskHeader.textContent = 'Tasks';
            header.appendChild(taskHeader);
            for (let day = 1; day <= 20; day++) {
                const thisDate = new Date(projectStartDate);
                thisDate.setDate(projectStartDate.getDate() + (day - 1));
                const dayOfWeek = dayNames[thisDate.getDay()];
                const dayOfMonth = thisDate.getDate();
                const label = `${dayOfWeek} ${dayOfMonth}`;
                const dayHeader = document.createElement('div');
                dayHeader.className = `header-cell ${day === currentDay ? 'current-day' : ''}`;
                dayHeader.textContent = label;
                header.appendChild(dayHeader);
            }
            grid.appendChild(header);
            tasks.forEach(task => {
                const row = document.createElement('div');
                row.className = 'task-row';
                row.dataset.taskId = task.id;
                // Task info with editable fields
                const taskInfo = document.createElement('div');
                taskInfo.className = 'task-info';
                taskInfo.innerHTML = `
                    <div class="task-name editable" onclick="editField(event, '${task.id}', 'name')">${task.name}</div>
                    <div class="task-crew editable" onclick="editField(event, '${task.id}', 'crew')">${task.crew}</div>
                    <button class="delete-btn" onclick="deleteTask('${task.id}')">üóëÔ∏è</button>
                `;
                row.appendChild(taskInfo);
                for (let day = 1; day <= 20; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell';
                    dayCell.dataset.day = day;
                    dayCell.dataset.taskId = task.id;
                    if (day === task.startDay) {
                        const taskBlock = createTaskBlock(task);
                        dayCell.appendChild(taskBlock);
                    }
                    dayCell.addEventListener('dragover', handleDragOver);
                    dayCell.addEventListener('drop', handleDrop);
                    dayCell.addEventListener('dragleave', handleDragLeave);
                    dayCell.addEventListener('dragenter', handleDragEnter);
                    row.appendChild(dayCell);
                }
                grid.appendChild(row);
            });
        }
        function editField(e, taskId, field) {
            e.stopPropagation();
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            const div = e.target;
            const oldValue = task[field];
            const input = document.createElement('input');
            input.type = 'text';
            input.value = oldValue;
            input.className = 'edit-input';
            input.onblur = () => finishEdit();
            input.onkeydown = ev => {
                if (ev.key === 'Enter') input.blur();
                if (ev.key === 'Escape') { input.value = oldValue; input.blur(); }
            };
            div.replaceWith(input);
            input.focus();
            input.select();
            function finishEdit() {
                task[field] = input.value.trim() === "" ? oldValue : input.value.trim();
                generateTimeline();
                updateSidebar();
                updateStats();
            }
        }
        function deleteTask(taskId) {
            if (confirm('Delete this task?')) {
                tasks = tasks.filter(t => t.id !== taskId);
                generateTimeline();
                updateSidebar();
                updateStats();
            }
        }
        function createTaskBlock(task) {
            const block = document.createElement('div');
            block.className = 'task-block';
            block.draggable = true;
            block.dataset.taskId = task.id;
            block.id = `task-block-${task.id}`;
            const crew = crews.find(c => c.name === task.crew);
            block.style.backgroundColor = crew ? crew.color : '#999';
            const width = task.duration * 60 - 10;
            block.style.width = `${width}px`;
            const isDelayed = task.startDay + task.duration - 1 < currentDay && task.status !== 'completed';
            const isLowEfficiency = task.efficiency < 70;
            if (isDelayed) block.classList.add('delayed');
            if (isLowEfficiency) block.classList.add('low-efficiency');
            block.innerHTML = `<div class="task-block-name">${task.name}</div>
                <div class="task-block-details"><div>${task.crew}</div><div>${task.duration}d</div></div>
                ${isDelayed ? '<div class="warning-badge">!</div>' : ''}
                ${isLowEfficiency ? `<div class="efficiency-badge">${task.efficiency}%</div>` : ''}`;
            block.addEventListener('dragstart', handleDragStart);
            block.addEventListener('dragend', handleDragEnd);
            return block;
        }
        function handleDragStart(e) {
            draggedTask = e.target.dataset.taskId;
            draggedElement = e.target;
            e.dataTransfer.effectAllowed = 'move';
            e.target.style.opacity = '0.5';
        }
        function handleDragEnd(e) { e.target.style.opacity = ''; }
        function handleDragEnter(e) { if (e.target.classList.contains('day-cell')) e.preventDefault(); }
        function handleDragOver(e) { if (e.target.classList.contains('day-cell')) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; e.target.classList.add('drop-target'); } }
        function handleDragLeave(e) { if (e.target.classList.contains('day-cell')) e.target.classList.remove('drop-target'); }
        function handleDrop(e) {
            e.preventDefault(); e.target.classList.remove('drop-target');
            if (!draggedTask || !e.target.classList.contains('day-cell')) return;
            const newDay = parseInt(e.target.dataset.day);
            const targetTaskId = e.target.dataset.taskId;
            const task = tasks.find(t => t.id === draggedTask);
            if (task && newDay && targetTaskId === task.id) {
                task.startDay = newDay;
                generateTimeline(); updateSidebar(); updateStats();
            }
            draggedTask = null; draggedElement = null;
        }
        function generateCrewPerformance() {
            const container = document.getElementById('crew-performance');
            container.innerHTML = '';
            crews.forEach(crew => {
                const crewTasks = tasks.filter(t => t.crew === crew.name);
                const avgEfficiency = crewTasks.length > 0 
                    ? Math.round(crewTasks.reduce((sum, t) => sum + t.efficiency, 0) / crewTasks.length)
                    : crew.efficiency;
                const crewDiv = document.createElement('div');
                crewDiv.className = 'crew-item';
                crewDiv.style.borderLeftColor = crew.color;
                crewDiv.style.backgroundColor = crew.color + '20';
                crewDiv.innerHTML = `<div class="crew-header"><span class="crew-name">${crew.name}</span>
                        <span class="efficiency-score ${avgEfficiency < 70 ? 'poor' : 'good'}">
                            ${avgEfficiency}% ${avgEfficiency < 70 ? '‚ö†Ô∏è' : ''}</span></div>
                    <div class="progress-bar"><div class="progress-fill" style="width: ${avgEfficiency}%; background-color: ${avgEfficiency < 70 ? '#dc2626' : crew.color};"></div></div>`;
                container.appendChild(crewDiv);
            });
        }
        function generateTaskOverview() {
            const container = document.getElementById('task-overview');
            container.innerHTML = '';
            tasks.forEach(task => {
                const isDelayed = task.startDay + task.duration - 1 < currentDay && task.status !== 'completed';
                const taskDiv = document.createElement('div');
                taskDiv.className = `task-summary ${isDelayed ? 'delayed' : 'normal'}`;
                taskDiv.innerHTML = `<div class="task-summary-name">${task.name}</div>
                    <div class="task-summary-details"><span>${task.crew}</span><span>${task.efficiency}% efficiency</span></div>
                    ${isDelayed ? '<div class="delayed-warning">‚ö†Ô∏è Behind Schedule</div>' : ''}`;
                container.appendChild(taskDiv);
            });
        }
        function updateStats() {
            const delayedTasks = tasks.filter(t => t.startDay + t.duration - 1 < currentDay && t.status !== 'completed').length;
            const lowEfficiencyTasks = tasks.filter(t => t.efficiency < 70).length;
            document.getElementById('current-day').textContent = currentDay;
            document.getElementById('delayed-count').textContent = delayedTasks;
            document.getElementById('low-efficiency-count').textContent = lowEfficiencyTasks;
        }
        function updateSidebar() { generateCrewPerformance(); generateTaskOverview(); }
        function toggleOptimizer() {
            const panel = document.getElementById('optimizer-panel');
            panel.classList.toggle('hidden');
        }
        function optimizeSchedule() {
            let optimizedTasks = JSON.parse(JSON.stringify(tasks));
            optimizedTasks.sort((a, b) => {
                const priorityWeight = { high: 3, medium: 2, low: 1 };
                const priorityDiff = priorityWeight[b.priority] - priorityWeight[a.priority];
                if (priorityDiff !== 0) return priorityDiff;
                return b.efficiency - a.efficiency;
            });
            let nextAvailableDay = 1;
            const crewSchedules = {};
            optimizedTasks.forEach(task => {
                const crewAvailable = crewSchedules[task.crew] || 1;
                task.startDay = Math.max(nextAvailableDay, crewAvailable);
                crewSchedules[task.crew] = task.startDay + task.duration;
                const bestCrew = crews.reduce((best, crew) => {
                    const crewEndDay = crewSchedules[crew.name] || 1;
                    if (crewEndDay <= task.startDay && crew.efficiency > best.efficiency) return crew;
                    return best;
                }, { efficiency: 0 });
                if (bestCrew.name) {
                    task.crew = bestCrew.name;
                    task.efficiency = Math.min(100, task.efficiency + 10);
                }
            });
            tasks = optimizedTasks;
            generateTimeline(); updateSidebar(); updateStats(); toggleOptimizer();
            alert('Schedule optimized! Tasks reorganized based on priorities and crew efficiency.');
        }
        function addNewTask() {
            const taskName = prompt('Enter task name:');
            if (taskName) {
                const crewName = prompt('Select crew (Crew A, Crew B, Crew C, or Crew D):', 'Crew A');
                const duration = parseInt(prompt('Enter duration in days:', '2')) || 2;
                const priority = prompt('Enter priority (high, medium, or low):', 'medium') || 'medium';
                const newTask = {
                    id: 'task-' + Date.now(),
                    name: taskName,
                    crew: crewName,
                    duration: duration,
                    startDay: currentDay + 1,
                    priority: priority.toLowerCase(),
                    status: 'scheduled',
                    efficiency: 75 + Math.floor(Math.random() * 20)
                };
                tasks.push(newTask);
                generateTimeline(); updateSidebar(); updateStats();
            }
        }
        function saveSchedule() {
            const scheduleData = {
                currentDay: currentDay,
                tasks: tasks,
                crews: crews,
                savedAt: new Date().toISOString()
            };
            const dataStr = JSON.stringify(scheduleData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'production-schedule-' + new Date().toISOString().split('T')[0] + '.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        function exportSchedule() {
            let report = 'PRODUCTION SCHEDULE REPORT\n';
            report += '==========================\n\n';
            report += `Generated: ${new Date().toLocaleString()}\n`;
            report += `Current Day: ${currentDay}\n\n`;
            report += 'TASK SCHEDULE:\n';
            report += '--------------\n';
            tasks.sort((a, b) => a.startDay - b.startDay).forEach(task => {
                const endDay = task.startDay + task.duration - 1;
                const status = task.startDay + task.duration - 1 < currentDay ? 'DELAYED' : 'On Schedule';
                report += `${task.name} (${task.crew})\n`;
                report += `  Days: ${task.startDay} - ${endDay} (${task.duration} days)\n`;
                report += `  Priority: ${task.priority}\n`;
                report += `  Efficiency: ${task.efficiency}%\n`;
                report += `  Status: ${status}\n\n`;
            });
            report += '\nCREW PERFORMANCE:\n';
            report += '-----------------\n';
            crews.forEach(crew => {
                const crewTasks = tasks.filter(t => t.crew === crew.name);
                const avgEfficiency = crewTasks.length > 0 
                    ? Math.round(crewTasks.reduce((sum, t) => sum + t.efficiency, 0) / crewTasks.length)
                    : crew.efficiency;
                report += `${crew.name}: ${avgEfficiency}% average efficiency\n`;
                report += `  Tasks: ${crewTasks.map(t => t.name).join(', ') || 'None'}\n\n`;
            });
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'production-schedule-report-' + new Date().toISOString().split('T')[0] + '.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Schedule report exported successfully!');
        }
        function init() {
            generateTimeline();
            updateSidebar();
            updateStats();
        }
        window.handleDragStart = handleDragStart;
        window.handleDragEnd = handleDragEnd;
        window.handleDragEnter = handleDragEnter;
        window.handleDragOver = handleDragOver;
        window.handleDragLeave = handleDragLeave;
        window.handleDrop = handleDrop;
        window.addNewTask = addNewTask;
        window.saveSchedule = saveSchedule;
        window.exportSchedule = exportSchedule;
        window.toggleOptimizer = toggleOptimizer;
        window.optimizeSchedule = optimizeSchedule;
        window.editField = editField;
        window.deleteTask = deleteTask;
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
